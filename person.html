<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Thailand 2026 – Person</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
:root{
  --accent:#0077b6; --accent2:#00b4d8; --bg:#f6f6f6; --card:#ffffff;
  --txt:#222;
}
*{box-sizing:border-box}
body{font-family:"Segoe UI",Arial,sans-serif;margin:0;background:var(--bg);color:var(--txt);}
.header{
  position:sticky;top:0;z-index:20;
  background:linear-gradient(90deg,var(--accent),#00629a);
  color:#fff;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;
  gap:12px;
}
.personName{margin:0;font-size:22px;font-weight:700}
.backBtn{
  border:0;padding:8px 12px;border-radius:8px;background:var(--accent2);color:#fff;cursor:pointer;font-weight:700;
}
.container{max-width:1200px;margin:18px auto;padding:12px}
.card{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
.dateBox{background:#fff;padding:10px;border-radius:8px;margin-bottom:10px;box-shadow:0 4px 10px rgba(0,0,0,0.03)}
.dateRow{display:flex;gap:8px;align-items:center;margin-top:6px}
.dateRow input[type="text"]{padding:6px;border-radius:6px;border:1px solid #ddd;width:100%}
.smallBtn{padding:6px 8px;border-radius:6px;border:0;background:var(--accent2);color:#fff;cursor:pointer;font-size:13px}
.ovRow{display:flex;gap:6px;align-items:center;margin-top:6px}
.ovRow select{padding:6px;border-radius:6px;border:1px solid #ddd;flex:1}
.iconBtn{border:0;background:transparent;cursor:pointer;font-size:14px}
.sideCard{background:#fff;padding:10px;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,0.03)}
.todo-item{display:flex;gap:6px;align-items:center;margin-bottom:8px}
.todo-item input[type="text"]{flex:1;padding:6px;border-radius:6px;border:1px solid #ddd}
</style>
</head>
<body>

<div class="header">
  <h1 class="personName" id="personName">Person</h1>
  <button class="backBtn" onclick="window.location.href='index.html'"><i class="fa-solid fa-arrow-left"></i> Übersicht</button>
</div>

<div class="container">
  <div class="card">
    <div id="dates"></div>
  </div>

  <div class="sideCard" style="margin-top:12px">
    <h3><i class="fa-solid fa-list-check"></i> To-Do</h3>
    <div id="todoList"></div>
    <button class="smallBtn" onclick="addTodoItem()"><i class="fa-solid fa-plus"></i> Neue Aufgabe</button>
  </div>
</div>

<script>
const params=new URLSearchParams(window.location.search);
const person=params.get("person")||"";
document.getElementById("personName").textContent=person;

/* Daten laden */
function loadData(){
  let d=localStorage.getItem("tripData");
  if(d) return JSON.parse(d);
  return {entries:{},overnightTypes:[],todos:{}};
}
let data=loadData();

/* Speichern */
function saveData(){
  localStorage.setItem("tripData",JSON.stringify(data));
}

/* Datumsarray */
const start=new Date(2026,1,16);
const end=new Date(2026,2,12);
function getDateList(){
  let arr=[];let days=Math.round((end-start)/86400000)+1;
  for(let i=0;i<days;i++){arr.push(new Date(start.getTime()+i*86400000));}
  return arr;
}

/* Übernachtungen-Dropdown bauen */
function overnightSelectHTML(dateKey,selectedId){
  let html=`<select onchange="changeOvernight('${dateKey}',this.value)">`;
  html+=`<option value="">- Übernachtung -</option>`;
  for(let o of data.overnightTypes){
    html+=`<option value="${o.id}" ${selectedId==o.id?'selected':''}>${o.label}</option>`;
  }
  html+=`<option value="__new__">+ Neuer Typ…</option>`;
  html+="</select>";
  return html;
}

/* Render */
function render(){
  // sicherstellen, dass Person in entries existiert
  if(!data.entries[person]) data.entries[person]={};

  // Tage rendern
  let html="";
  for(let dt of getDateList()){
    let key=dt.toISOString().slice(0,10);
    if(!data.entries[person][key]) data.entries[person][key]=[];
    let entries=data.entries[person][key];
    html+=`<div class="dateBox">
             <strong>${key}</strong>
             <button class="smallBtn" onclick="addEntry('${key}')"><i class="fa-solid fa-plus"></i> Eintrag</button>`;
    entries.forEach((e,idx)=>{
      html+=`<div class="dateRow">
               <input type="text" value="${e.text||""}" oninput="editEntry('${key}',${idx},this.value)">
               <button class="iconBtn" onclick="deleteEntry('${key}',${idx})"><i class="fa-solid fa-trash"></i></button>
             </div>`;
    });
    // Übernachtung
    let selId=entries.length>0?entries[0].overnightId||"":"";
    html+=`<div class="ovRow">${overnightSelectHTML(key,selId)}
             <button class="iconBtn" onclick="editOvernightTypes()"><i class="fa-solid fa-gear"></i></button>
           </div>`;
    html+="</div>";
  }
  document.getElementById("dates").innerHTML=html;

  // ToDos rendern
  if(!data.todos[person]) data.todos[person]=[];
  let todoHtml="";
  data.todos[person].forEach((t,i)=>{
    todoHtml+=`<div class="todo-item">
                 <input type="text" value="${t}" oninput="editTodo(${i},this.value)">
                 <button class="iconBtn" onclick="deleteTodo(${i})"><i class="fa-solid fa-trash"></i></button>
               </div>`;
  });
  document.getElementById("todoList").innerHTML=todoHtml;
}

/* Entry functions */
function addEntry(dateKey){
  data.entries[person][dateKey].push({text:"",overnightId:""});
  saveData();render();
}
function editEntry(dateKey,idx,val){
  data.entries[person][dateKey][idx].text=val;
  saveData();
}
function deleteEntry(dateKey,idx){
  data.entries[person][dateKey].splice(idx,1);
  saveData();render();
}

/* Overnight change */
function changeOvernight(dateKey,val){
  if(val==="__new__"){
    let newLabel=prompt("Neuer Übernachtungstyp:");
    if(newLabel){
      let newId=Date.now();
      data.overnightTypes.push({id:newId,label:newLabel});
      // setzen für aktuellen Tag
      setOvernight(dateKey,newId);
    }
  }else{
    setOvernight(dateKey,val?parseInt(val):"");
  }
}
function setOvernight(dateKey,id){
  if(data.entries[person][dateKey].length===0){
    data.entries[person][dateKey].push({text:"",overnightId:id});
  }else{
    data.entries[person][dateKey][0].overnightId=id;
  }
  saveData();render();
}

/* Bearbeiten/Löschen von Typen */
function editOvernightTypes(){
  let list=data.overnightTypes.map(o=>`${o.id}: ${o.label}`).join("\n");
  alert("Übernachtungstypen:\n"+list+"\n\nLöschen: localStorage in DevTools bearbeiten oder hier erweitern.");
}

/* ToDo functions */
function addTodoItem(){
  data.todos[person].push("");
  saveData();render();
}
function editTodo(i,val){
  data.todos[person][i]=val;
  saveData();
}
function deleteTodo(i){
  data.todos[person].splice(i,1);
  saveData();render();
}

render();
</script>
</body>
</html>