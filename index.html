<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Thailand 2026</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
:root{
  --accent:#0077b6; --accent2:#00b4d8; --bg:#f6f6f6; --card:#ffffff;
  --txt:#222; --gray1:#fbfbfb; --gray2:#f0f0f0;
  --location-bg:#d9d9dd; /* new gray for place */
  --overnight-bg:#e8f5ff; --overnight-accent:#2b95ff;
  --btn-width:160px;
}
*{box-sizing:border-box}
body{font-family:"Segoe UI",Arial,sans-serif;margin:0;background:var(--bg);color:var(--txt);}

/* Header (sticky) */
.header{
  background:linear-gradient(90deg,var(--accent),#00629a);
  color:#fff;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px;position:sticky;top:0;z-index:100;
}
.header .title{font-size:18px;font-weight:700;margin:0}
.header .langBtns{display:flex;gap:8px}
.langBtn{border:0;padding:8px 12px;border-radius:8px;background:var(--accent2);color:#fff;cursor:pointer;font-weight:700}

/* Layout */
.container{max-width:1200px;margin:18px auto;padding:12px}
.card{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
.small{font-size:13px;color:#444}

/* Table */
.table-wrap{overflow:auto;border-radius:8px}
table{width:100%;border-collapse:collapse;font-size:14px}
th,td{border:1px solid #e2e2e2;padding:8px;text-align:center;vertical-align:top}
thead th{position:sticky;top:0;background:#fafafa;z-index:5}
.sticky-date{position:sticky;left:0;background:#fff;z-index:6;font-weight:700;width:140px;min-width:120px}

/* entries */
.entry{display:block;padding:8px;margin:6px auto;border-radius:6px;text-align:center;border:1px solid rgba(0,0,0,0.03);max-width:260px;word-wrap:break-word}
.entry .meta{font-size:12px;color:#666;margin-top:4px}
.entry .text{font-size:14px;white-space:normal;}
.entry.odd { background: var(--gray1); }
.entry.even{ background: var(--gray2); }
.entry.overnight{ background: var(--overnight-bg); border-left:4px solid var(--overnight-accent); }
.entry.overnight .text{ font-weight:700; color:var(--overnight-accent); }

/* person base colors */
.personColRouven{background: linear-gradient(180deg,#fff0f0,#ffd9d9);} 
.personColDaniel{background: linear-gradient(180deg,#f0fff0,#d9ffd9);} 
.personColHenrik{background: linear-gradient(180deg,#eef4ff,#d9e7ff);} 
.personColBenja{background: linear-gradient(180deg,#fffaf0,#fff1d9);} 
.personColHolger{background: linear-gradient(180deg,#f7efff,#f0d9ff);} 

.weekendDate{background:#ffd699;font-weight:700;color:#222}

/* Editor */
.editorHeader{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:10px;position:sticky;top:58px;background:transparent;padding-top:6px;z-index:95}
.personBadge{display:flex;align-items:center;gap:10px}
.badgeCircle{width:48px;height:48px;border-radius:50%;display:inline-block}
.personName{font-weight:900;font-size:22px}
.editorGrid{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:980px){ .editorGrid{grid-template-columns:1fr 360px} }

/* day box */
.entryBox{background:#fff;padding:12px;border-radius:8px;margin-bottom:10px;box-shadow:0 4px 10px rgba(0,0,0,0.03)}
.entryBoxHeader{display:flex;justify-content:space-between;align-items:center;gap:8px}
.entryRow{display:flex;gap:8px;align-items:center;margin-top:8px}
.entryRow .text{flex:1;padding:6px;border-radius:6px;border:1px solid #eee;background:transparent}
.smallBtn{padding:6px 8px;border-radius:6px;border:0;background:var(--accent2);color:#fff;cursor:pointer;font-weight:700}

/* To-Do (under calendar) */
.todoContainer{margin-top:20px;padding:12px;border-radius:8px;background:#fff;box-shadow:0 4px 10px rgba(0,0,0,0.03)}
.todo-item{display:flex;gap:6px;align-items:center;margin-bottom:8px}
.todo-item input[type="text"]{flex:1;padding:6px;border-radius:6px;border:1px solid #ddd}
.todo-actions button{padding:6px;border-radius:6px;border:0;background:#f0f0f0;cursor:pointer}

/* Overnight specific */
.overnight-wrap{display:flex;align-items:center;gap:8px;margin-top:8px}
.overnight-label{font-size:12px;color:#666;margin-bottom:6px}
.overnight-field{flex:1;padding:8px;border-radius:8px;background:var(--overnight-bg);border:1px solid rgba(43,149,255,0.15);display:flex;align-items:center;justify-content:space-between}
.overnight-field.booked{background:#cbefff;border-color:var(--overnight-accent)}
.overnight-text{padding:6px;flex:1}
.overnight-actions{display:flex;gap:6px;align-items:center;padding-left:8px}

/* icons/buttons */
.icon-btn{background:transparent;border:0;padding:6px;border-radius:6px;cursor:pointer}
.icon-btn.save{color:var(--accent2)}
.icon-btn.delete{color:#c0392b}
.icon-btn.adopt{color:#2b95ff}
.icon-btn.add{color:#1f7d3a}

/* adopt layout */
.adopt-wrap{display:flex;gap:8px;align-items:center;margin-top:8px}
.adopt-wrap select{padding:6px;border-radius:6px;border:1px solid #ddd;flex:1}

/* day separator */
.day-sep{border-top:1px dashed #e0e0e0;margin:10px 0}

/* helpers */
.kv{font-size:13px;color:#666}
.note{font-size:13px;color:#555;margin-top:8px}
.location-box{background:var(--location-bg);padding:8px;border-radius:8px;margin-bottom:8px;text-align:center;font-weight:700}
.location-input{padding:6px;border-radius:6px;border:1px solid #ddd;width:45%;margin:0 6px}
.sticky-controls{position:sticky;top:58px;display:flex;align-items:center;gap:8px;background:transparent;padding:6px;z-index:96}
.ctrl-btn{width:var(--btn-width);padding:8px;border-radius:8px;border:0;background:rgba(0,0,0,0.06);cursor:pointer;font-weight:700}
.ctrl-btn.center{margin:0 auto}
.ctrl-btn.right{margin-left:auto}
</style>
</head>
<body>

<div class="header">
  <div class="title" id="pageTitle">Thailand 2026</div>
  <div class="langBtns">
    <button class="langBtn" onclick="setLang('de')">DE</button>
    <button class="langBtn" onclick="setLang('th')">ไทย</button>
  </div>
</div>

<div class="container">
  <div class="card" id="overviewCard">
    <div class="controls">
      <div class="small kv" id="rangeInfo">16.02. — 11.03. 2026</div>
      <div style="flex:1"></div>
      <div class="small kv" id="langLabel">Deutsch</div>
    </div>

    <!-- Übersicht -->
    <div id="overview">
      <div class="table-wrap">
        <table id="calendarTable" aria-label="Reiseübersicht">
          <thead id="calendarHead"></thead>
          <tbody id="calendarBody"></tbody>
        </table>
      </div>
      <p class="note" id="overviewHint">Klicke auf einen Namen, um die persönliche Seite (inline Editor) zu öffnen.</p>
    </div>
  </div>

  <!-- Editor (Personenseite) -->
  <div id="editorCard" class="card" style="display:none;margin-top:14px;">
    <div class="editorHeader">
      <div class="personBadge">
        <div class="badgeCircle" id="badgeColorPerson"></div>
        <div><div class="personName" id="editorName">Person</div></div>
      </div>

      <div class="sticky-controls" id="stickyControls">
        <button class="ctrl-btn" id="btnCal" onclick="showPersonCalendar()">Kalender</button>
        <button class="ctrl-btn" id="btnTodoView" onclick="showPersonTodos()">To-Do-Liste</button>
        <button class="ctrl-btn right" id="btnBack" onclick="closeEditor()">Übersicht</button>
      </div>
    </div>

    <div class="editorGrid">
      <div id="personCalendarList"></div>

      <div id="personTodos" class="todoContainer" style="display:none;">
        <h4 id="todoTitle">To-Do</h4>
        <div id="todoList"></div>
        <div style="margin-top:8px">
          <button class="smallBtn" onclick="openNewTodoArea()"><i class="fa-solid fa-plus"></i> <span id="newTaskLabel">Neue Aufgabe</span></button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ===========================
   Config & initial data
   =========================== */

/* Languages & UI text */
const LANGTEXT = {
  de: {
    pageTitle: "Thailand 2026",
    closeLabel: "Übersicht",
    overnightTitle: "Übernachtung",
    todoTitle: "To-Do-Liste",
    newTaskLabel: "Neue Aufgabe",
    overviewHint: "Klicke auf einen Namen, um die persönliche Seite (inline Editor) zu öffnen.",
    addEntryLabel: "+ Eintrag",
    btnDelete: "Löschen",
    defaultTodo: "Gültiger Reisepass (mind. bis 09/2026)",
    persons: {Rouven:"Rouven",Daniel:"Daniel",Henrik:"Henrik",Benja:"Benja",Holger:"Holger"},
    bookedLabel: "Gebucht",
    addOvernight: "+ Übernachtung",
    removeOvernight: "Übernachtung entfernen",
    adoptLabel: "Übernehmen",
    newOvernightText: "Neue Übernachtung",
    newEntryText: "Neuer Eintrag",
    newLocationText: "Neuer Ort",
    confirmDelete: "Möchten Sie wirklich löschen?",
    dayNames: ["Sonntag","Montag","Dienstag","Mittwoch","Donnerstag","Freitag","Samstag"],
    placeDefaults: [
      {de:'Bangkok', th:'กรุงเทพมหานคร'},
      {de:'Sa Kaeo', th:'สระแก้ว'},
      {de:'Koh Lanta', th:'อเกาะลันตา'},
      {de:'Phuket', th:'ภูเก็ต'}
    ],
    specialActivities: {
      "2026-02-16":[ {de:"Abflug Frankfurt/Main Flughafen 20.55 Uhr", th:"ออกเดินทางจากสนามบินแฟรังก์เฟิร์ต 20:55 น."} ],
      "2026-02-17":[ {de:"Ankunft Bangkok-Suvarnabhumi 13.45 Uhr", th:"ถึงกรุงเทพฯ สนามบินสุวรรณภูมิ 13:45 น."}, {de:"Chao Phraya Bootstour", th:"ทัวร์เรือบนแม่น้ำเจ้าพระยา"} ],
      "2026-02-19":[ {de:"Familienfeier", th:"การเฉลิมฉลองในครอบครัว"} ],
      "2026-02-24":[ {de:"Upasampada-Feier / Wat Don Din Daeng", th:"พิธีอุปสมบท / วัดดอนดินแดง"} ],
      "2026-02-25":[ {de:"Upasampada-Zeremonie", th:"พิธีอุปสมบท / วัดดอนดินแดง"} ],
      "2026-02-26":[ {de:"Einweihungsfeier", th:"งานปาร์ตี้ขึ้นบ้านใหม่"} ],
      "2026-03-11":[ {de:"Abflug Bangkok-Suvarnabhumi 12.40 Uhr", th:"เที่ยวบินกลับ กรุงเทพฯ-สุวรรณภูมิ เวลา 12:40 น."}, {de:"Ankunft Frankfurt/Main Flughafen 19.05 Uhr", th:"เดินทางถึงสนามบินแฟรงก์เฟิร์ต/ไมน์ เวลา 19.05 น."} ]
    }
  },
  th: {
    pageTitle: "ประเทศไทย 2026",
    closeLabel: "ภาพรวม",
    overnightTitle: "ที่พัก",
    todoTitle: "รายการสิ่งที่ต้องทำ",
    newTaskLabel: "งานใหม่",
    overviewHint: "คลิกที่ชื่อเพื่อเปิดหน้าส่วนตัว (ตัวแก้ไขแบบอินไลน์)",
    addEntryLabel: "+ รายการ",
    btnDelete: "ลบ",
    defaultTodo: "หนังสือเดินทางที่ถูกต้อง (อย่างน้อยถึง 09/2026)",
    persons: {Rouven:"รูเวน",Daniel:"แดเนียล",Henrik:"เฮนริก",Benja:"เบนจา",Holger:"โฮลเกอร์"},
    bookedLabel: "จองแล้ว",
    addOvernight: "+ เพิ่มที่พัก",
    removeOvernight: "ลบที่พัก",
    adoptLabel: "นำมาใช้",
    newOvernightText: "ที่พักค้างคืนใหม่",
    newEntryText: "กิจกรรมใหม่",
    newLocationText: "ที่ตั้งใหม่",
    confirmDelete: "ต้องการลบจริงหรือไม่?",
    dayNames: ["อาทิตย์","จันทร์","อังคาร","พุธ","พฤหัสบดี","ศุกร์","เสาร์"],
    placeDefaults: [
      {de:'Bangkok', th:'กรุงเทพมหานคร'},
      {de:'Sa Kaeo', th:'สระแก้ว'},
      {de:'Koh Lanta', th:'อเกาะลันตา'},
      {de:'Phuket', th:'ภูเก็ต'}
    ],
    specialActivities: { /* same content as de but kept in LANGTEXT.de used earlier for exact strings */ }
  }
};

/* core config */
const START = new Date(2026,1,16); // Feb 16
const END   = new Date(2026,2,11); // Mar 11
const PERSONS = [
  {id:'Rouven', name:'Rouven', class:'personColRouven'},
  {id:'Daniel', name:'Daniel', class:'personColDaniel'},
  {id:'Henrik', name:'Henrik', class:'personColHenrik'},
  {id:'Benja', name:'Benja', class:'personColBenja'},
  {id:'Holger', name:'Holger', class:'personColHolger'}
];
const STORAGE_KEY = 'trip2026_complete_v1';
const SPECIAL_OVERDATE = '2026-02-16'; // special overnight only on this date

/* data model:
data = { entries: { 'YYYY-MM-DD': { personId: [ {de,th}, ... ] } }, overnight: { personId: { 'YYYY-MM-DD': {de,th,booked} } }, locations: { personId: { 'YYYY-MM-DD': {de,th} } }, todos: { personId: [ {id,de,th,done} ] }, pools: { activity: { 'YYYY-MM-DD': [{de,th}] }, overnight: { 'YYYY-MM-DD': [{de,th}] }, place: { 'YYYY-MM-DD': [{de,th}] } } }
*/

let data = null;
let lang = 'de';
let currentPerson = null;

/* helpers */
function pad(n){ return String(n).padStart(2,'0'); }
function formatKey(d){ return d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate()); }
function formatLabel(d){ return pad(d.getDate()) + '.' + pad(d.getMonth()+1) + '.'; }
function daysInRange(s,e){ const s0=new Date(s.getFullYear(),s.getMonth(),s.getDate()), e0=new Date(e.getFullYear(),e.getMonth(),e.getDate()); return Math.round((e0 - s0)/86400000) + 1; }
function dateByOffset(s,offset){ return new Date(s.getFullYear(), s.getMonth(), s.getDate() + offset); }
function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function makeId(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,8); }

/* create empty structure and seed preset */
function createEmptyData(){
  const d = { entries:{}, overnight:{}, locations:{}, todos:{}, pools:{ activity:{}, overnight:{}, place:{} } };
  const days = daysInRange(START,END);
  for(let i=0;i<days;i++){
    const dt = dateByOffset(START,i); const k = formatKey(dt);
    d.entries[k] = {};
    PERSONS.forEach(p => d.entries[k][p.id] = []);
  }
  PERSONS.forEach(p => { d.overnight[p.id] = {}; d.locations[p.id] = {}; d.todos[p.id] = [ { id: makeId(), de: LANGTEXT.de.defaultTodo, th: LANGTEXT.th ? LANGTEXT.th.defaultTodo : LANGTEXT.de.defaultTodo, done:false } ]; });
  // no pools yet; preset applied next
  return d;
}

/* merge preset entries into data (activities). Uses LANGTEXT.de.specialActivities for stable payload. */
function mergePresetInto(d){
  const preset = LANGTEXT.de.specialActivities;
  for(const dateKey in preset){
    if(!d.entries[dateKey]) continue;
    const arr = preset[dateKey];
    arr.forEach(item=>{
      PERSONS.forEach(p=>{
        const list = d.entries[dateKey][p.id] || [];
        const exists = list.some(e => ((e.de||'')===item.de && (e.th||'')===item.th));
        if(!exists) list.push({de:item.de, th:item.th});
        d.entries[dateKey][p.id] = list;
      });
    });
  }
  // special overnight default for Holger on 2026-02-16 as requested earlier (keeps parity)
  if(d.overnight && d.overnight['Holger']){
    d.overnight['Holger'][SPECIAL_OVERDATE] = { de: LANGTEXT.de.overnight16, th: LANGTEXT.th ? LANGTEXT.th.overnight16 || LANGTEXT.de.overnight16 : LANGTEXT.de.overnight16, booked:false };
    // add to pool overnight for that date (but rule says only available as special on that date)
    if(!d.pools.overnight[SPECIAL_OVERDATE]) d.pools.overnight[SPECIAL_OVERDATE] = [];
    const k = (LANGTEXT.de.overnight16||'').trim() + '||' + (LANGTEXT.th?LANGTEXT.th.overnight16 || LANGTEXT.de.overnight16:LANGTEXT.de.overnight16).trim();
    if(!d.pools.overnight[SPECIAL_OVERDATE].some(x => ((x.de||'')+'||'+(x.th||'')).trim() === k)) {
      d.pools.overnight[SPECIAL_OVERDATE].push({de: LANGTEXT.de.overnight16, th: LANGTEXT.th ? LANGTEXT.th.overnight16 || LANGTEXT.de.overnight16 : LANGTEXT.de.overnight16});
    }
  }
}

/* load/save */
function loadData(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw){
    data = createEmptyData();
    mergePresetInto(data);
    saveData();
    return;
  }
  try{
    data = JSON.parse(raw);
    // ensure keys exist
    if(!data.entries || !data.overnight || !data.todos || !data.locations || !data.pools) {
      data = createEmptyData();
      mergePresetInto(data);
      saveData();
      return;
    }
    // ensure date/person shape
    const days = daysInRange(START,END);
    for(let i=0;i<days;i++){
      const dt = dateByOffset(START,i); const k = formatKey(dt);
      if(!data.entries[k]){ data.entries[k] = {}; PERSONS.forEach(p => data.entries[k][p.id] = []); }
      else PERSONS.forEach(p => { if(!data.entries[k][p.id]) data.entries[k][p.id] = []; });
    }
    PERSONS.forEach(p => { if(!data.overnight[p.id]) data.overnight[p.id] = {}; if(!data.locations[p.id]) data.locations[p.id] = {}; if(!Array.isArray(data.todos[p.id]) || data.todos[p.id].length===0) data.todos[p.id] = [ { id: makeId(), de: LANGTEXT.de.defaultTodo, th: LANGTEXT.th ? LANGTEXT.th.defaultTodo : LANGTEXT.de.defaultTodo, done:false } ]; });
    if(!data.pools) data.pools = { activity:{}, overnight:{}, place:{} };
    mergePresetInto(data);
  } catch(e){
    console.error('load error', e);
    data = createEmptyData(); mergePresetInto(data); saveData();
  }
}
function saveData(){
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); } catch(e){ console.error('save error', e); }
  renderOverview();
  if(currentPerson) renderPersonEditor();
}

/* ===========================
   Pools & dedupe helpers
   =========================== */

/* Add entry to pool for category/date only if not duplicate */
function addToPool(category, dateKey, item){
  if(!data.pools) data.pools = { activity:{}, overnight:{}, place:{} };
  if(!data.pools[category]) data.pools[category] = {};
  if(!data.pools[category][dateKey]) data.pools[category][dateKey] = [];
  const key = ((item.de||'').trim() + '||' + (item.th||'').trim());
  const exists = data.pools[category][dateKey].some(x => ((x.de||'').trim() + '||' + (x.th||'').trim()) === key);
  if(!exists) data.pools[category][dateKey].push({de:item.de||'', th:item.th||''});
}

/* Retrieve deduplicated activity options for date (preset + pool + any person's entries), returns array of {de,th,source} */
function getActivityOptions(dateKey){
  const opts = []; const seen = new Set();
  // preset (LANGTEXT.de.specialActivities)
  const preset = LANGTEXT.de.specialActivities[dateKey] || [];
  preset.forEach(it=>{
    const k = ((it.de||'').trim()+'||'+(it.th||'').trim());
    if(!seen.has(k)){ seen.add(k); opts.push({de:it.de, th:it.th, source:'preset'}); }
  });
  // pool
  if(data.pools && data.pools.activity && data.pools.activity[dateKey]){
    data.pools.activity[dateKey].forEach(it=>{
      const k = ((it.de||'').trim()+'||'+(it.th||'').trim());
      if(!seen.has(k)){ seen.add(k); opts.push({de:it.de, th:it.th, source:'pool'}); }
    });
  }
  // entries across persons
  PERSONS.forEach(p=>{
    const list = (data.entries[dateKey] && data.entries[dateKey][p.id]) ? data.entries[dateKey][p.id] : [];
    list.forEach(it=>{
      const k = ((it.de||'').trim()+'||'+(it.th||'').trim());
      if(!seen.has(k)){ seen.add(k); opts.push({de:it.de, th:it.th, source:p.id}); }
    });
  });
  return opts;
}

/* Overnight options: exclude special "Flugzeug" on other dates */
function getOvernightOptions(dateKey){
  const opts = []; const seen = new Set();
  // pool
  if(data.pools && data.pools.overnight && data.pools.overnight[dateKey]){
    data.pools.overnight[dateKey].forEach(it=>{
      const k = ((it.de||'').trim()+'||'+(it.th||'').trim());
      if(!seen.has(k)){ seen.add(k); opts.push({de:it.de, th:it.th, source:'pool'}); }
    });
  }
  // overnight entries across persons
  PERSONS.forEach(p=>{
    const ov = (data.overnight[p.id] && data.overnight[p.id][dateKey]) ? data.overnight[p.id][dateKey] : null;
    if(ov && ((ov.de&&ov.de.trim()) || (ov.th&&ov.th.trim()))){
      const k = ((ov.de||'').trim()+'||'+(ov.th||'').trim());
      if(!seen.has(k)){ seen.add(k); opts.push({de:ov.de, th:ov.th, source:p.id}); }
    }
  });
  return opts;
}

/* Place options: include defaults + pool + locations across persons */
function getPlaceOptions(dateKey){
  const opts = []; const seen = new Set();
  // defaults
  const defaults = LANGTEXT.de.placeDefaults || LANGTEXT[lang].placeDefaults;
  defaults.forEach(d=>{
    const k = ((d.de||'').trim()+'||'+(d.th||'').trim());
    if(!seen.has(k)){ seen.add(k); opts.push({de:d.de, th:d.th, source:'default'}); }
  });
  // pool
  if(data.pools && data.pools.place && data.pools.place[dateKey]){
    data.pools.place[dateKey].forEach(it=>{
      const k = ((it.de||'').trim()+'||'+(it.th||'').trim());
      if(!seen.has(k)){ seen.add(k); opts.push({de:it.de, th:it.th, source:'pool'}); }
    });
  }
  // locations across persons
  PERSONS.forEach(p=>{
    const loc = (data.locations[p.id] && data.locations[p.id][dateKey]) ? data.locations[p.id][dateKey] : null;
    if(loc && ((loc.de&&loc.de.trim()) || (loc.th&&loc.th.trim()))){
      const k = ((loc.de||'').trim()+'||'+(loc.th||'').trim());
      if(!seen.has(k)){ seen.add(k); opts.push({de:loc.de, th:loc.th, source:p.id}); }
    }
  });
  return opts;
}

/* ===========================
   Rendering: Overview
   =========================== */

const calendarHead = document.getElementById('calendarHead');
const calendarBody = document.getElementById('calendarBody');
const pageTitleEl = document.getElementById('pageTitle');
const rangeInfoEl = document.getElementById('rangeInfo');
const overviewHintEl = document.getElementById('overviewHint');
const langLabelEl = document.getElementById('langLabel');

function renderOverview(){
  pageTitleEl.textContent = LANGTEXT[lang].pageTitle || 'Thailand 2026';
  rangeInfoEl.textContent = `${formatLabel(START)} — ${formatLabel(END)} 2026`;
  overviewHintEl.textContent = LANGTEXT[lang].overviewHint || '';

  // table head
  let headHtml = `<tr><th class="sticky-date">${(lang==='de'?'Datum':'วันที่')}</th>`;
  PERSONS.forEach(p=>{
    const name = LANGTEXT[lang].persons[p.id] || p.name;
    headHtml += `<th><button class="langBtn" onclick="openEditor('${p.id}')">${esc(name)}</button></th>`;
  });
  headHtml += `</tr>`;
  calendarHead.innerHTML = headHtml;

  // table body
  const days = daysInRange(START,END);
  let bodyHtml = '';
  for(let i=0;i<days;i++){
    const dt = dateByOffset(START,i); const key = formatKey(dt);
    const weekday = LANGTEXT[lang].dayNames[dt.getDay()];
    const dateLabel = `${weekday} ${formatLabel(dt)}`;
    const isWeekend = (dt.getDay()===0 || dt.getDay()===6);
    const dateClass = isWeekend ? 'sticky-date weekendDate' : 'sticky-date';
    bodyHtml += `<tr><td class="${dateClass}">${esc(dateLabel)}</td>`;
    PERSONS.forEach(p=>{
      const entries = (data.entries[key] && data.entries[key][p.id]) ? data.entries[key][p.id] : [];
      const ov = (data.overnight[p.id] && data.overnight[p.id][key]) ? data.overnight[p.id][key] : null;
      const loc = (data.locations[p.id] && data.locations[p.id][key]) ? data.locations[p.id][key] : null;
      const combined = [];
      if(loc && ((loc.de && loc.de.trim()) || (loc.th && loc.th.trim()))) combined.push({...loc, _type:'location'});
      entries.forEach(e=> combined.push({...e, _type:'entry'}));
      if(ov && ((ov.de && ov.de.trim()) || (ov.th && ov.th.trim()) || ov.booked)) combined.push({...ov, _type:'overnight'});
      // stable ordering: location first, then activities (sorted by any time parse if needed), then overnight last
      let cellHtml = '';
      combined.forEach((e, idx)=>{
        const text = (lang==='de') ? (e.de||'') : (e.th||e.de||'');
        let baseCls = (e._type==='overnight') ? 'entry overnight' : (e._type==='location' ? 'location-box' : 'entry');
        const parity = (idx % 2 === 0) ? 'odd' : 'even';
        // For location, render special box
        if(e._type==='location'){
          cellHtml += `<div class="location-box">${esc(text)}</div>`;
        } else {
          cellHtml += `<div class="${baseCls} ${parity}"><div class="text">${esc(text)}</div>` +
                      (e._type==='overnight' && e.booked ? `<div class="meta"><i class="fa-solid fa-check"></i> ${LANGTEXT[lang].bookedLabel}</div>` : '') +
                      `</div>`;
        }
      });
      bodyHtml += `<td class="${p.class}">${cellHtml}</td>`;
    });
    bodyHtml += '</tr>';
  }
  calendarBody.innerHTML = bodyHtml;
}

/* ===========================
   Editor: Person page and actions
   =========================== */

function openEditor(personId){
  currentPerson = personId;
  document.getElementById('overviewCard').style.display = 'none';
  document.getElementById('editorCard').style.display = 'block';
  document.getElementById('editorName').textContent = LANGTEXT[lang].persons[personId] || personId;
  // set badge color by person
  const map = {
    Rouven: 'linear-gradient(180deg,#fff0f0,#ffd9d9)',
    Daniel: 'linear-gradient(180deg,#f0fff0,#d9ffd9)',
    Henrik: 'linear-gradient(180deg,#eef4ff,#d9e7ff)',
    Benja:  'linear-gradient(180deg,#fffaf0,#fff1d9)',
    Holger: 'linear-gradient(180deg,#f7efff,#f0d9ff)'
  };
  document.getElementById('badgeColorPerson').style.background = map[personId] || '#fff';
  setLangButtons();
  showPersonCalendar();
  renderPersonEditor();
}

function closeEditor(){
  currentPerson = null;
  document.getElementById('editorCard').style.display = 'none';
  document.getElementById('overviewCard').style.display = 'block';
  saveData();
}

/* sticky controls text / active state */
function setLangButtons(){
  document.getElementById('btnCal').textContent = (lang==='de' ? 'Kalender' : 'ปฏิทิน');
  document.getElementById('btnTodoView').textContent = (lang==='de' ? 'To-Do-Liste' : 'รายการสิ่งที่ต้องทำ');
  document.getElementById('btnBack').textContent = (lang==='de' ? LANGTEXT.de.closeLabel : LANGTEXT.th.closeLabel);
  document.getElementById('todoTitle').textContent = (lang==='de' ? LANGTEXT.de.todoTitle : LANGTEXT.th.todoTitle);
  document.getElementById('newTaskLabel').textContent = (lang==='de' ? LANGTEXT.de.newTaskLabel : LANGTEXT.th.newTaskLabel);
}

/* Show calendar or todos for person */
function showPersonCalendar(){ document.getElementById('personCalendarList').style.display = 'block'; document.getElementById('personTodos').style.display = 'none'; document.getElementById('btnCal').classList.add('active'); document.getElementById('btnTodoView').classList.remove('active'); }
function showPersonTodos(){ document.getElementById('personCalendarList').style.display = 'none'; document.getElementById('personTodos').style.display = 'block'; document.getElementById('btnTodoView').classList.add('active'); document.getElementById('btnCal').classList.remove('active'); }

/* render person editor calendar & todos */
function renderPersonEditor(){
  if(!currentPerson) return;
  // calendar
  const days = daysInRange(START,END);
  let html = '';
  for(let i=0;i<days;i++){
    const dt = dateByOffset(START,i); const key = formatKey(dt);
    const weekday = LANGTEXT[lang].dayNames[dt.getDay()];
    const label = `${weekday} ${formatLabel(dt)}`;
    html += `<div class="entryBox">`;
    html += `<div class="entryBoxHeader"><strong>${esc(label)}</strong></div>`;

    // PLACE area: show place dropdown/adopt/new, display current
    html += `<div class="location-box">`;
    const loc = (data.locations[currentPerson] && data.locations[currentPerson][key]) ? data.locations[currentPerson][key] : null;
    const shownLoc = loc ? (lang==='de' ? loc.de : loc.th) : '';
    html += `<div style="flex:1;text-align:center;font-weight:700">${esc(shownLoc || (lang==='de' ? LANGTEXT.de.newLocation : LANGTEXT.th.newLocation))}</div>`;
    html += `</div>`;
    // Adopt / New place controls
    html += `<div class="adopt-wrap"><select id="placeSelect-${key}"><option value="-1">-- ${esc(lang==='de' ? LANGTEXT.de.newLocation : LANGTEXT.th.newLocation)} --</option>`;
    const placeOpts = getPlaceOptions(key);
    placeOpts.forEach((p,pi)=>{ const txt = (lang==='de'?p.de:p.th); html += `<option value="${pi}">${esc(txt)}${p.source?' ('+p.source+')':''}</option>`; });
    html += `</select><button class="icon-btn adopt" onclick="adoptPlace('${key}')"><i class="fa-solid fa-hand-point-up"></i></button>`;
    html += `<button class="icon-btn" onclick="showNewPlaceInputs('${key}')"><i class="fa-solid fa-plus"></i></button></div>`;
    html += `<div id="newPlaceContainer-${key}" style="margin-top:6px"></div>`;
    if(loc){
      html += `<div style="margin-top:6px;display:flex;gap:8px;align-items:center;justify-content:center"><button class="icon-btn delete" onclick="deleteLocationConfirm('${key}')"><i class="fa-solid fa-trash"></i> ${(lang==='de'? 'Löschen' : 'ลบ')}</button></div>`;
    }

    html += `<div class="day-sep"></div>`;

    // Activities: adopt dropdown + new inputs (both langs)
    html += `<div><div style="font-weight:700;margin-bottom:6px">${lang==='de'?'Aktivitäten':'กิจกรรม'}</div>`;
    html += `<div class="adopt-wrap"><select id="actSelect-${key}"><option value="-1">-- ${esc(lang==='de'?LANGTEXT.de.newEntryText:LANGTEXT.th.newEntryText)} --</option>`;
    const actOpts = getActivityOptions(key);
    actOpts.forEach((a,ai)=>{ const txt = (lang==='de'?a.de:a.th); html += `<option value="${ai}">${esc(txt)}${a.source?(' ('+a.source+')'):''}</option>`; });
    html += `</select><button class="icon-btn adopt" onclick="adoptActivity('${key}')"><i class="fa-solid fa-hand-point-up"></i></button></div>`;
    html += `<div id="newActArea-${key}" style="margin-top:6px;display:flex;gap:6px;align-items:center">
               <input id="newAct-de-${key}" placeholder="DE" class="location-input">
               <input id="newAct-th-${key}" placeholder="TH" class="location-input">
               <button class="icon-btn save" onclick="saveNewActivity('${key}')"><i class="fa-solid fa-check"></i></button>
             </div>`;
    // show existing activities for this person/date
    const entries = (data.entries[key] && data.entries[key][currentPerson]) ? data.entries[key][currentPerson] : [];
    entries.forEach((e, idx) => {
      const shown = lang==='de' ? (e.de||'') : (e.th||e.de||'');
      html += `<div class="entryRow" style="align-items:center;margin-top:8px">
                <div class="text">${esc(shown)}</div>
                <div style="display:flex;gap:6px;align-items:center">
                  <button class="icon-btn" title="hoch" onclick="moveEntry('${key}',${idx},-1)"><i class="fa-solid fa-arrow-up"></i></button>
                  <button class="icon-btn" title="runter" onclick="moveEntry('${key}',${idx},1)"><i class="fa-solid fa-arrow-down"></i></button>
                  <button class="icon-btn delete" title="${esc(lang==='de'?LANGTEXT.de.btnDelete:LANGTEXT.th.btnDelete)}" onclick="deleteEntryConfirm('${key}',${idx})"><i class="fa-solid fa-trash"></i></button>
                </div></div>`;
    });
    html += `</div>`; // activities

    html += `<div class="day-sep"></div>`;

    // Overnight area
    html += `<div class="overnight-section"><div class="overnight-label">${esc(lang==='de'?LANGTEXT.de.overnightTitle:LANGTEXT.th.overnightTitle)}</div>`;
    const ov = (data.overnight[currentPerson] && data.overnight[currentPerson][key]) ? data.overnight[currentPerson][key] : null;
    if(ov){
      const shownOv = lang==='de' ? (ov.de||'') : (ov.th||ov.de||'');
      const bookedCls = ov.booked ? 'booked' : '';
      html += `<div class="overnight-wrap">
                <div class="overnight-field ${bookedCls}" id="ovfield-${key}">
                  <div class="overnight-text">${esc(shownOv)}</div>
                  <div class="overnight-actions">
                    <label style="display:flex;align-items:center;gap:6px"><input type="checkbox" id="ovBooked-${key}" ${ov.booked ? 'checked' : ''} onchange="toggleOvernightBooked('${key}', this.checked)"> ${esc(lang==='de'?LANGTEXT.de.bookedLabel:LANGTEXT.th.bookedLabel)}</label>
                    <button class="icon-btn delete" title="${esc(lang==='de'?LANGTEXT.de.removeOvernight:LANGTEXT.th.removeOvernight)}" onclick="removeOvernightConfirm('${key}')"><i class="fa-solid fa-trash"></i></button>
                  </div>
                </div>
              </div>`;
    } else {
      // show dropdown with global options for date (special handling for 16.02)
      html += `<div class="overnight-wrap">
                <div style="flex:1">
                  <div class="overnight-field" style="background:linear-gradient(180deg,#f8fbff,#f0f8ff);border:1px solid rgba(0,0,0,0.04);">
                    <div style="padding:6px;color:#666">${esc(lang==='de'?LANGTEXT.de.overnightTitle:LANGTEXT.th.overnightTitle)}</div>
                  </div>
                </div>
                <div style="display:flex;flex-direction:column;gap:6px;align-items:center">
                  <button class="icon-btn add" title="${esc(lang==='de'?LANGTEXT.de.addOvernight:LANGTEXT.th.addOvernight)}" onclick="openOvernightPicker('${key}')"><i class="fa-solid fa-bed fa-lg"></i></button>
                </div>
              </div>
              <div id="ov-adopter-${key}" style="margin-top:6px"></div>`;
    }

    html += `</div>`; // overnight-section

    html += `</div>`; // entryBox
  }

  document.getElementById('personCalendarList').innerHTML = html;

  // todos rendering on right column
  renderTodos();
  renderOvernightTypesList();
}

/* ========== Entry operations ========== */
function deleteEntryConfirm(dateKey, idx){
  if(!confirm(LANGTEXT[lang].confirmDelete)) return;
  if(!data.entries[dateKey] || !data.entries[dateKey][currentPerson]) return;
  data.entries[dateKey][currentPerson].splice(idx,1);
  saveData();
  renderPersonEditor();
}
function moveEntry(dateKey, idx, dir){
  const arr = (data.entries[dateKey] && data.entries[dateKey][currentPerson]) ? data.entries[dateKey][currentPerson] : null;
  if(!arr) return;
  const newIdx = idx + dir;
  if(newIdx < 0 || newIdx >= arr.length) return;
  const tmp = arr[newIdx]; arr[newIdx] = arr[idx]; arr[idx] = tmp;
  saveData();
  renderPersonEditor();
}

/* adopt activity */
function adoptActivity(dateKey){
  const sel = document.getElementById('actSelect-'+dateKey);
  if(!sel) return;
  const idx = parseInt(sel.value,10);
  if(isNaN(idx) || idx === -1) return;
  const opts = getActivityOptions(dateKey);
  const chosen = opts[idx];
  if(!chosen) return;
  if(!data.entries[dateKey]) data.entries[dateKey] = {};
  if(!data.entries[dateKey][currentPerson]) data.entries[dateKey][currentPerson] = [];
  const exists = data.entries[dateKey][currentPerson].some(x => ((x.de||'').trim() === (chosen.de||'').trim() && (x.th||'').trim() === (chosen.th||'').trim()));
  if(!exists){
    data.entries[dateKey][currentPerson].push({de:chosen.de, th:chosen.th});
    addToPool('activity', dateKey, {de:chosen.de, th:chosen.th});
    saveData();
  }
  renderPersonEditor();
}

/* new activity save (both languages required input fields exist) */
function saveNewActivity(dateKey){
  const de = (document.getElementById('newAct-de-'+dateKey)||{}).value || '';
  const th = (document.getElementById('newAct-th-'+dateKey)||{}).value || '';
  if(!de && !th) return;
  if(!data.entries[dateKey]) data.entries[dateKey] = {};
  if(!data.entries[dateKey][currentPerson]) data.entries[dateKey][currentPerson] = [];
  const exists = data.entries[dateKey][currentPerson].some(x => ((x.de||'').trim() === de.trim() && (x.th||'').trim() === th.trim()));
  if(!exists){
    data.entries[dateKey][currentPerson].push({de:de, th:th});
    addToPool('activity', dateKey, {de:de, th:th});
    saveData();
  }
  renderPersonEditor();
}

/* ========== Overnight: adopt/create/save/toggle/remove ========== */
function openOvernightPicker(dateKey){
  const container = document.getElementById('ov-adopter-'+dateKey);
  if(!container) return;
  const globals = getOvernightOptions(dateKey);
  let html = `<div class="adopt-wrap"><select id="ovSelect-${dateKey}"><option value="-1">${esc(lang==='de'?LANGTEXT.de.newOvernightText:LANGTEXT.th.newOvernightText)}</option>`;
  // if special date -> include special option but only that one, as requested
  if(dateKey === SPECIAL_OVERDATE){
    html += `<option value="__special__">${esc(lang==='de'?LANGTEXT.de.overnight16: (LANGTEXT.th && LANGTEXT.th.overnight16?LANGTEXT.th.overnight16:LANGTEXT.de.overnight16))}</option>`;
  }
  globals.forEach((g,ii)=>{
    // ensure "Flugzeug" appears only on special date: we already excluded others by not populating pool with it for other dates
    const txt = (lang==='de') ? (g.de||g.th) : (g.th||g.de);
    html += `<option value="${ii}">${esc(txt)}</option>`;
  });
  html += `</select><button class="icon-btn adopt" onclick="ovAdoptOrCreate('${dateKey}')"><i class="fa-solid fa-check"></i></button></div>`;
  container.innerHTML = html;
}

function ovAdoptOrCreate(dateKey){
  const sel = document.getElementById('ovSelect-'+dateKey);
  if(!sel) return;
  const val = sel.value;
  if(val === '__special__'){
    // set special overnight
    if(!data.overnight[currentPerson]) data.overnight[currentPerson] = {};
    data.overnight[currentPerson][dateKey] = { de: LANGTEXT.de.overnight16, th: LANGTEXT.th ? (LANGTEXT.th.overnight16 || LANGTEXT.de.overnight16) : LANGTEXT.de.overnight16, booked:false };
    // also add to pool for that date if not present (we keep special present only for that date)
    addToPool('overnight', dateKey, {de: LANGTEXT.de.overnight16, th: LANGTEXT.th ? (LANGTEXT.th.overnight16 || LANGTEXT.de.overnight16) : LANGTEXT.de.overnight16});
    saveData(); renderPersonEditor(); return;
  }
  const idx = parseInt(val,10);
  if(isNaN(idx) || idx === -1){
    // new creation flow: show dual inputs
    const container = document.getElementById('ov-adopter-'+dateKey);
    container.innerHTML = `<div style="display:flex;gap:8px;align-items:center">
      <input id="ovNewDE-${dateKey}" placeholder="DE" style="flex:1;padding:6px;border-radius:6px;border:1px solid #ddd">
      <input id="ovNewTH-${dateKey}" placeholder="TH" style="flex:1;padding:6px;border-radius:6px;border:1px solid #ddd">
      <button class="icon-btn save" onclick="saveNewOvernight('${dateKey}')"><i class="fa-solid fa-check"></i></button>
      <button class="icon-btn" onclick="document.getElementById('ov-adopter-${dateKey}').innerHTML=''"><i class="fa-solid fa-xmark"></i></button>
    </div>`;
    return;
  }
  // adopt from options
  const opts = getOvernightOptions(dateKey);
  const chosen = opts[idx];
  if(!chosen) return;
  if(!data.overnight[currentPerson]) data.overnight[currentPerson] = {};
  data.overnight[currentPerson][dateKey] = { de: chosen.de||'', th: chosen.th||'', booked:false };
  addToPool('overnight', dateKey, {de:chosen.de||'', th:chosen.th||''});
  saveData();
  renderPersonEditor();
}

function saveNewOvernight(dateKey){
  const de = (document.getElementById('ovNewDE-'+dateKey)||{}).value || '';
  const th = (document.getElementById('ovNewTH-'+dateKey)||{}).value || '';
  if(!de && !th) return;
  if(!data.overnight[currentPerson]) data.overnight[currentPerson] = {};
  data.overnight[currentPerson][dateKey] = { de:de, th:th, booked:false };
  addToPool('overnight', dateKey, {de:de, th:th});
  saveData();
  renderPersonEditor();
}

function toggleOvernightBooked(dateKey, checked){
  if(!data.overnight[currentPerson]) data.overnight[currentPerson] = {};
  if(!data.overnight[currentPerson][dateKey]) return;
  data.overnight[currentPerson][dateKey].booked = !!checked;
  saveData();
}

function removeOvernightConfirm(dateKey){
  if(!confirm(LANGTEXT[lang].confirmDelete)) return;
  if(data.overnight[currentPerson] && data.overnight[currentPerson][dateKey]){
    delete data.overnight[currentPerson][dateKey];
    saveData(); renderPersonEditor();
  }
}

/* ========== Place adoption & new place flows ========== */
function adoptPlace(dateKey){
  const sel = document.getElementById('placeSelect-'+dateKey);
  if(!sel) return;
  const idx = parseInt(sel.value,10);
  if(isNaN(idx) || idx === -1) return;
  const opts = getPlaceOptions(dateKey);
  const chosen = opts[idx];
  if(!chosen) return;
  if(!data.locations[currentPerson]) data.locations[currentPerson] = {};
  data.locations[currentPerson][dateKey] = { de: chosen.de||'', th: chosen.th||'' };
  addToPool('place', dateKey, {de:chosen.de||'', th:chosen.th||''});
  saveData();
  renderPersonEditor();
}

function showNewPlaceInputs(dateKey){
  const container = document.getElementById('newPlaceContainer-'+dateKey);
  if(!container) return;
  container.innerHTML = `<div style="display:flex;gap:8px;align-items:center">
    <input id="newPlace-de-${dateKey}" placeholder="DE" style="padding:6px;border-radius:6px;border:1px solid #ddd;flex:1">
    <input id="newPlace-th-${dateKey}" placeholder="TH" style="padding:6px;border-radius:6px;border:1px solid #ddd;flex:1">
    <button class="icon-btn save" onclick="saveNewPlace('${dateKey}')"><i class="fa-solid fa-check"></i></button>
    <button class="icon-btn" onclick="document.getElementById('newPlaceContainer-${dateKey}').innerHTML=''"><i class="fa-solid fa-xmark"></i></button>
  </div>`;
}

function saveNewPlace(dateKey){
  const de = (document.getElementById('newPlace-de-'+dateKey)||{}).value || '';
  const th = (document.getElementById('newPlace-th-'+dateKey)||{}).value || '';
  if(!de && !th) return;
  if(!data.locations[currentPerson]) data.locations[currentPerson] = {};
  data.locations[currentPerson][dateKey] = { de:de, th:th };
  addToPool('place', dateKey, {de:de, th:th});
  saveData();
  renderPersonEditor();
}

function deleteLocationConfirm(dateKey){
  if(!confirm(LANGTEXT[lang].confirmDelete)) return;
  if(data.locations[currentPerson] && data.locations[currentPerson][dateKey]){
    delete data.locations[currentPerson][dateKey];
    saveData(); renderPersonEditor();
  }
}

/* ========== Todos (per person), dual-language new entry flow ========== */
function renderTodos(){
  if(!currentPerson) return;
  if(!data.todos[currentPerson]) data.todos[currentPerson] = [ { id: makeId(), de: LANGTEXT.de.defaultTodo, th: LANGTEXT.th ? LANGTEXT.th.defaultTodo : LANGTEXT.de.defaultTodo, done:false } ];
  const wrap = document.getElementById('todoList');
  let html = '';
  data.todos[currentPerson].forEach((t,i)=>{
    const shown = (lang==='de') ? (t.de || '') : (t.th || '');
    html += `<div class="todo-item"><input type="checkbox" ${t.done ? 'checked' : ''} onchange="toggleTodo(${i},this.checked)">
      <input type="text" value="${esc(shown)}" placeholder="${lang==='de'? 'DE' : 'TH'}" oninput="updateTodo(${i}, '${lang}', this.value)">
      <div class="todo-actions"><button class="icon-btn delete" onclick="deleteTodo(${i})"><i class="fa-solid fa-trash"></i></button></div>
    </div>`;
  });
  // area for creating new todo (both languages)
  html += `<div style="margin-top:8px;display:flex;gap:8px;align-items:center">
    <input id="newTodo-de" placeholder="DE" style="flex:1;padding:6px;border-radius:6px;border:1px solid #ddd">
    <input id="newTodo-th" placeholder="TH" style="flex:1;padding:6px;border-radius:6px;border:1px solid #ddd">
    <button class="icon-btn save" onclick="saveNewTodo()"><i class="fa-solid fa-check"></i></button>
  </div>`;
  wrap.innerHTML = html;
}

function openNewTodoArea(){ document.getElementById('newTodo-de').focus && document.getElementById('newTodo-de').focus(); }

function saveNewTodo(){
  const de = (document.getElementById('newTodo-de')||{}).value || '';
  const th = (document.getElementById('newTodo-th')||{}).value || '';
  if(!de && !th) return;
  if(!data.todos[currentPerson]) data.todos[currentPerson] = [];
  data.todos[currentPerson].push({ id: makeId(), de:de, th:th, done:false });
  saveData();
  renderTodos();
}

function toggleTodo(i, checked){
  if(!data.todos[currentPerson] || !data.todos[currentPerson][i]) return;
  data.todos[currentPerson][i].done = !!checked;
  saveData();
}
function updateTodo(i, fieldLang, v){
  if(!data.todos[currentPerson] || !data.todos[currentPerson][i]) return;
  if(fieldLang === 'de') data.todos[currentPerson][i].de = v;
  else data.todos[currentPerson][i].th = v;
  saveData();
}
function deleteTodo(i){
  if(!confirm(LANGTEXT[lang].confirmDelete)) return;
  data.todos[currentPerson].splice(i,1);
  saveData();
  renderTodos();
}

/* ========== Overnight types list (side) - manage types (kept but not interfering) ========== */
function renderOvernightTypesList(){
  const wrap = document.getElementById('overnightTypesList');
  // Show the pool aggregated across all dates (unique by label in current language)
  const seen = new Set();
  let html = '';
  // gather all overnight options from pools across dates
  const flat = [];
  if(data.pools && data.pools.overnight){
    for(const d in data.pools.overnight) data.pools.overnight[d].forEach(o => flat.push(o));
  }
  // also include any overnight set by persons
  PERSONS.forEach(p=>{
    for(const d in data.overnight[p.id]){
      const o = data.overnight[p.id][d];
      if(o && ((o.de&&o.de.trim()) || (o.th&&o.th.trim()))) flat.push({de:o.de, th:o.th});
    }
  });
  flat.forEach(o=>{
    const key = ((o.de||'').trim()+'||'+(o.th||'').trim());
    if(!seen.has(key)){ seen.add(key); html += `<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px"><div style="flex:1">${esc(lang==='de'?o.de:o.th)}</div></div>`; }
  });
  if(!html) html = `<div style="color:#666">—</div>`;
  wrap.innerHTML = html;
}

/* ========== Language switch ========== */
function setLang(l){
  if(l !== 'de' && l !== 'th') return;
  lang = l;
  document.getElementById('pageTitle').textContent = LANGTEXT[lang].pageTitle || 'Thailand 2026';
  document.getElementById('langLabel').textContent = (lang==='de' ? 'Deutsch' : 'ไทย');
  document.getElementById('overviewHint').textContent = LANGTEXT[lang].overviewHint || '';
  // update any open editor labels
  if(currentPerson){
    document.getElementById('editorName').textContent = LANGTEXT[lang].persons[currentPerson] || currentPerson;
  }
  renderOverview();
  if(currentPerson) renderPersonEditor();
}

/* ===========================
   Start (load data and render)
   =========================== */
loadData();
renderOverview();

/* initial expose */
window.setLang = setLang;
window.openEditor = openEditor;
window.closeEditor = closeEditor;
window.adoptActivity = adoptActivity;
window.saveNewActivity = saveNewActivity;
window.moveEntry = moveEntry;
window.deleteEntryConfirm = deleteEntryConfirm;
window.openOvernightPicker = openOvernightPicker;
window.ovAdoptOrCreate = ovAdoptOrCreate;
window.saveNewOvernight = saveNewOvernight;
window.toggleOvernightBooked = toggleOvernightBooked;
window.removeOvernightConfirm = removeOvernightConfirm;
window.adoptPlace = adoptPlace;
window.saveNewPlace = saveNewPlace;
window.deleteLocationConfirm = deleteLocationConfirm;
window.addTodoItem = addTodoItem;
window.renderTodos = renderTodos;
window.addToPool = addToPool;
window.getActivityOptions = getActivityOptions;
window.getOvernightOptions = getOvernightOptions;
window.getPlaceOptions = getPlaceOptions;
</script>
</body>
</html>
