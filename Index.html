<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Thailand 2026 — Planung</title>
<style>
  :root{
    --bg:#0f1720; --card:#0b1220; --muted:#9aa5b1; --accent:#60a5fa;
    --rouven: #4A90E2; --daniel: #7ED321; --henrik: #F5A623; --benja: #9013FE; --holger: #D0021B;
    --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  body{font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial; margin:0; background:linear-gradient(180deg,#00111a 0%, #052430 100%); color:#e6eef6; -webkit-font-smoothing:antialiased}
  header{display:flex;align-items:center;gap:16px;padding:18px 22px;border-bottom:1px solid rgba(255,255,255,0.03);background:linear-gradient(90deg, rgba(255,255,255,0.02), transparent)}
  h1{margin:0;font-size:18px}
  .container{padding:18px;max-width:1200px;margin:20px auto}
  .nav{display:flex;gap:8px;align-items:center}
  .btn{background:var(--glass);border:1px solid rgba(255,255,255,0.03);padding:8px 12px;border-radius:8px;color:var(--muted);cursor:pointer}
  .btn.primary{background:linear-gradient(90deg,var(--accent),#7dd3fc);color:#032; font-weight:600}
  .grid{display:grid;grid-template-columns:1fr 400px;gap:18px}
  .card{background:rgba(255,255,255,0.03);border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.03)}
  /* main table */
  .table{width:100%;border-collapse:collapse;overflow:auto}
  .thead{display:grid;grid-template-columns:160px repeat(5,1fr);gap:8px;margin-bottom:8px}
  .thead .col{padding:8px;border-radius:8px;color:#021; font-weight:700}
  .thead .c-rouven{background:linear-gradient(90deg,var(--rouven), rgba(74,144,226,0.6));}
  .thead .c-daniel{background:linear-gradient(90deg,var(--daniel), rgba(126,211,33,0.5));}
  .thead .c-henrik{background:linear-gradient(90deg,var(--henrik), rgba(245,166,35,0.4));}
  .thead .c-benja{background:linear-gradient(90deg,var(--benja), rgba(144,19,254,0.3));}
  .thead .c-holger{background:linear-gradient(90deg,var(--holger), rgba(208,2,27,0.4));}
  .row{display:grid;grid-template-columns:160px repeat(5,1fr);gap:8px;padding:8px 0;border-bottom:1px dashed rgba(255,255,255,0.02);align-items:start}
  .datecell{font-weight:700;color:var(--muted);width:160px}
  .personcell{min-height:48px;padding:6px;border-radius:8px;background:rgba(255,255,255,0.01)}
  .entry{background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:8px;margin-bottom:6px;font-size:14px}
  .entry small{display:block;color:var(--muted);font-size:12px}
  .personheader{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:8px;color:#021;font-weight:700}
  .personname{padding:6px 10px;border-radius:8px;background:rgba(255,255,255,0.9);opacity:0.95}
  .personlink{color:#e6eef6;text-decoration:none;font-size:13px}
  /* person page */
  .person-top{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:12px}
  .person-columns{display:grid;grid-template-columns:160px 1fr 220px;gap:12px}
  .dates-list{max-height:520px;overflow:auto}
  .date-item{padding:8px;border-radius:8px;margin-bottom:6px;background:rgba(255,255,255,0.01);cursor:pointer}
  .date-item.active{outline:2px solid rgba(255,255,255,0.03);background:linear-gradient(90deg, rgba(255,255,255,0.02), transparent)}
  .entries{max-height:520px;overflow:auto}
  .entry-row{display:flex;gap:8px;align-items:flex-start;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);margin-bottom:8px}
  .entry-actions{margin-left:auto;display:flex;gap:6px}
  .small{font-size:13px;color:var(--muted)}
  input[type=text], textarea{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:rgba(0,0,0,0.25);color:inherit}
  label{display:block;font-size:14px;margin-bottom:6px}
  .todo-list{max-height:200px;overflow:auto;margin-top:8px}
  .todo-row{display:flex;gap:8px;align-items:center;padding:6px;background:rgba(255,255,255,0.01);border-radius:8px;margin-bottom:6px}
  .muted{color:var(--muted)}
  .translate-bar{display:flex;gap:8px;align-items:center}
  .footer-note{font-size:12px;color:var(--muted);margin-top:10px}
  /* responsive */
  @media (max-width:950px){
    .grid{grid-template-columns:1fr;gap:12px}
    .person-columns{grid-template-columns:1fr;gap:12px}
    .thead{display:none}
    .row{grid-template-columns:1fr;gap:6px}
    .datecell{display:none}
  }
</style>
</head>
<body>
<header>
  <div style="display:flex;align-items:center;gap:12px">
    <h1>Thailand 2026 — Planung</h1>
    <div class="muted">Statische Demo — lokale Speicherung</div>
  </div>
  <div style="margin-left:auto" class="nav">
    <button id="nav-main" class="btn">Startseite</button>
    <div id="person-links" style="display:flex;gap:6px"></div>
  </div>
</header>

<div class="container">
  <div id="app"></div>
</div>

<!-- Templates / Modals -->
<!-- simple modal container -->
<div id="modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;z-index:9999">
  <div id="modal-inner" style="width:90%;max-width:720px;background:#021221;padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)">
    <div id="modal-content"></div>
    <div style="text-align:right;margin-top:10px">
      <button id="modal-cancel" class="btn">Abbrechen</button>
      <button id="modal-ok" class="btn primary">OK</button>
    </div>
  </div>
</div>

<script>
/*
  Thailand 2026 - Single-file static app
  - Stores data in localStorage under key 'thailand2026_data'
  - Navigation: #/ (main) | #/person/NAME[?date=YYYY-MM-DD]
  - Simple client-side password gating (not secure)
  - Translation: uses LibreTranslate public endpoint (falls aus, gibt Fehlermeldung)
*/

/* ---------- config ---------- */
const APP_KEY = 'thailand2026_data_v1';
const PERSONS = [
  {id:'Rouven', color:'var(--rouven)', pwd: ''},
  {id:'Daniel', color:'var(--daniel)', pwd: ''},
  {id:'Henrik', color:'var(--henrik)', pwd: ''},
  {id:'Benja', color:'var(--benja)', pwd: ''},
  {id:'Holger', color:'var(--holger)', pwd: 'x****7'} // Passwort exakt so wie angegeben
];
const START_DATE = '2026-02-16';
const END_DATE = '2026-03-12';

/* LibreTranslate endpoint (öffentliche Instanz). Kann ausfallen */
const TRANSLATE_ENDPOINT = 'https://libretranslate.de/translate';

/* ---------- utilities ---------- */
function iso(date){
  // date -> YYYY-MM-DD
  const y = date.getFullYear();
  const m = String(date.getMonth()+1).padStart(2,'0');
  const d = String(date.getDate()).padStart(2,'0');
  return `${y}-${m}-${d}`;
}
function fmtDE(isoDate){
  const [y,m,d] = isoDate.split('-');
  return `${d}.${m}.${y}`;
}
function uid(prefix='id'){ return prefix + '_' + Date.now().toString(36) + Math.random().toString(36).slice(2,7); }

/* date range */
function datesBetween(startIso, endIso){
  const s = new Date(startIso);
  const e = new Date(endIso);
  const out = [];
  const cur = new Date(s);
  while (cur <= e){
    out.push(iso(cur));
    cur.setDate(cur.getDate()+1);
  }
  return out;
}

/* ---------- storage & default data ---------- */
function defaultData(){
  const d = {};
  d.dates = datesBetween(START_DATE, END_DATE);
  d.persons = {};
  PERSONS.forEach(p=>{
    d.persons[p.id] = {
      entries: {},   // entries[YYYY-MM-DD] = [{id,text,original?}]
      overnight: {}, // overnight[YYYY-MM-DD] = {note,booked}
      todos: []      // [{id,text,done,original?}]
    };
    // ensure arrays for each date
    d.dates.forEach(date => {
      d.persons[p.id].entries[date] = [];
      d.persons[p.id].overnight[date] = {note:'', booked:false};
    });
  });

  // Prefill requested entries
  const fill = [
    {date:'2026-02-16', text:'Abflug Frankfurt/Main Flughafen 20.55 Uhr'},
    {date:'2026-02-17', text:'Ankunft Bangkok-Suvarnabhumi 13.45 Uhr'},
    {date:'2026-02-17', text:'River Cruise'},
    {date:'2026-03-11', text:'Abflug Bangkok-Suvarnabhumi 12.40 Uhr // Ankunft Frankfurt/Main Flughafen 19.05 Uhr'}
  ];
  PERSONS.forEach(p=> {
    fill.forEach(item => {
      d.persons[p.id].entries[item.date].push({id: uid('e'), text: item.text});
    });
  });

  d.translations = {}; // cache: key = md5(text+target) -> translated
  return d;
}

function loadData(){
  try {
    const raw = localStorage.getItem(APP_KEY);
    if (!raw) {
      const dat = defaultData();
      saveData(dat);
      return dat;
    }
    return JSON.parse(raw);
  } catch(e){
    console.error('load error',e);
    const dat = defaultData();
    saveData(dat);
    return dat;
  }
}
function saveData(data){
  localStorage.setItem(APP_KEY, JSON.stringify(data));
}

/* ---------- app state ---------- */
let DATA = loadData();

/* ---------- simple routing ---------- */
function navigateTo(hash){
  location.hash = hash;
}
function parseHash(){
  const h = location.hash || '#/';
  // #/person/NAME?date=YYYY-MM-DD
  if (h.startsWith('#/person/')){
    const rest = h.slice('#/person/'.length);
    const [path, q] = rest.split('?');
    const person = decodeURIComponent(path || '');
    const params = {};
    if (q){
      q.split('&').forEach(p=>{
        const [k,v]=p.split('=');
        params[decodeURIComponent(k)] = decodeURIComponent(v||'');
      });
    }
    return {view:'person', person, params};
  } else {
    return {view:'main'};
  }
}

/* ---------- render ---------- */
const app = document.getElementById('app');
const personLinksContainer = document.getElementById('person-links');
document.getElementById('nav-main').addEventListener('click', ()=> navigateTo('#/'));

function buildPersonLinks(){
  personLinksContainer.innerHTML = '';
  PERSONS.forEach(p=>{
    const a = document.createElement('button');
    a.className = 'btn';
    a.textContent = p.id;
    a.style.borderLeft = `4px solid ${getPersonColor(p.id)}`;
    a.addEventListener('click', ()=> navigateTo('#/person/' + encodeURIComponent(p.id)));
    personLinksContainer.appendChild(a);
  });
}
buildPersonLinks();

function getPersonColor(name){
  const p = PERSONS.find(x=>x.id===name);
  return p ? p.color : '#666';
}

/* MAIN PAGE */
function renderMain(){
  DATA = loadData();
  const dates = DATA.dates;
  let html = '';
  html += `<div class="card"><div class="thead">`;
  html += `<div class="col" style="background:transparent;color:var(--muted);font-weight:700">Datum</div>`;
  PERSONS.forEach(p=>{
    html += `<div class="col ${'c-'+p.id.toLowerCase()}" style="background:${p.color}">` +
            `<div style="display:flex;align-items:center;gap:8px">` +
            `<span class="personname">${p.id}</span>` +
            `</div></div>`;
  });
  html += `</div>`; // thead

  html += `<div>`;
  dates.forEach(date=>{
    html += `<div class="row">`;
    html += `<div class="datecell small">${fmtDE(date)}</div>`;
    PERSONS.forEach(person=>{
      const cells = DATA.persons[person.id].entries[date] || [];
      html += `<div class="personcell">`;
      if (cells.length === 0){
        html += `<div class="small muted">— keine Einträge —</div>`;
      } else {
        cells.forEach(item=>{
          html += `<div class="entry" title="Klicke um zur Personenseite zu springen" data-person="${person.id}" data-date="${date}" data-id="${item.id}">` +
                  `<div>${escapeHtml(item.text)}</div>` +
                  `</div>`;
        });
      }
      // add link to person page with date preselected
      html += `<div style="display:flex;justify-content:flex-end;margin-top:6px">` +
              `<button class="btn" data-action="open-person" data-person="${person.id}" data-date="${date}">+ Eintrag</button>` +
              `</div>`;
      html += `</div>`; // personcell
    });
    html += `</div>`; // row
  });
  html += `</div></div>`; // wrapper

  app.innerHTML = html;

  // attach events: open-person
  document.querySelectorAll('[data-action="open-person"]').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      const p = btn.dataset.person;
      const d = btn.dataset.date;
      navigateTo('#/person/' + encodeURIComponent(p) + '?date=' + encodeURIComponent(d));
    });
  });

  // clicking entry goes to person page
  document.querySelectorAll('.entry').forEach(el=>{
    el.addEventListener('click', ()=>{
      const p = el.dataset.person;
      const d = el.dataset.date;
      navigateTo('#/person/' + encodeURIComponent(p) + '?date=' + encodeURIComponent(d));
    });
  });
}

/* PERSON PAGE */
function renderPersonPage(personName, params = {}){
  DATA = loadData();
  const pdata = DATA.persons[personName];
  if (!pdata) {
    app.innerHTML = `<div class="card">Person nicht gefunden</div>`;
    return;
  }
  const dates = DATA.dates;
  // determine selected date
  let selDate = params.date || dates[0];

  const color = getPersonColor(personName);
  // Header with edit/save and translate
  let html = `<div class="card">` +
    `<div class="person-top">` +
    `<div style="display:flex;gap:12px;align-items:center">` +
    `<div class="personname" style="background:${color};color:#021">${personName}</div>` +
    `<div class="small muted">Zeitraum: ${fmtDE(dates[0])} — ${fmtDE(dates[dates.length-1])}</div>` +
    `</div>` +
    `<div style="display:flex;gap:8px;align-items:center">` +
    `<div class="translate-bar">` +
      `<button id="btn-translate-th" class="btn">Thai</button>` +
      `<button id="btn-translate-de" class="btn">Deutsch</button>` +
    `</div>` +
    `<button id="btn-edit" class="btn">Bearbeiten</button>` +
    `<button id="btn-save" class="btn primary" style="display:none">Speichern</button>` +
    `</div></div>`; // person-top

  html += `<div class="person-columns">` +
    // dates list left
    `<div class="card dates-list">` +
    `<div style="font-weight:700;margin-bottom:8px">Datum</div>`;
  dates.forEach(d=>{
    html += `<div class="date-item ${d===selDate?'active':''}" data-date="${d}">` +
            `<div style="display:flex;justify-content:space-between;align-items:center">` +
              `<div><strong>${fmtDE(d)}</strong></div>` +
              `<div class="small muted">${(pdata.entries[d]||[]).length} Einträge</div>` +
            `</div></div>`;
  });
  html += `</div>`; // dates-list

  // center entries column
  html += `<div class="card entries">` +
    `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">` +
    `<div><strong>Einträge — ${fmtDE(selDate)}</strong></div>` +
    `<div><button id="btn-add-entry" class="btn">+ Eintrag hinzufügen</button></div>` +
    `</div>` +
    `<div id="entries-container">`;
  const entriesForSel = pdata.entries[selDate] || [];
  if (entriesForSel.length === 0) {
    html += `<div class="muted">Keine Einträge für dieses Datum.</div>`;
  } else {
    entriesForSel.forEach(it=>{
      html += `<div class="entry-row" data-id="${it.id}">` +
              `<div class="entry-text">${escapeHtml(it.text)}</div>` +
              `<div class="entry-actions">` +
                `<button class="btn edit-entry" data-id="${it.id}" style="display:none">✎</button>` +
                `<button class="btn del-entry" data-id="${it.id}" style="display:none">🗑</button>` +
              `</div></div>`;
    });
  }
  html += `</div>`; // entries-container
  html += `<div class="footer-note">Hinweis: Einträge werden nach "Speichern" in den lokalen Speicher geschrieben und sind dann auf dieser Maschine sichtbar.</div>`;
  html += `</div>`; // entries card

  // right column: Übernachtung + ToDo
  html += `<div class="card">` +
    `<div style="font-weight:700;margin-bottom:8px">Übernachtung — ${fmtDE(selDate)}</div>` +
    `<div style="margin-bottom:8px">` +
      `<label>Notiz</label>` +
      `<textarea id="overnote" rows="3">${escapeHtml(pdata.overnight[selDate]?.note || '')}</textarea>` +
    `</div>` +
    `<div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">` +
      `<label style="margin:0;display:flex;align-items:center;gap:6px"><input id="overn-booked" type="checkbox" ${pdata.overnight[selDate]?.booked ? 'checked' : ''} disabled /> <span>Gebucht</span></label>` +
    `</div>` +
    `<hr style="border-color:rgba(255,255,255,0.02);margin:10px 0">` +
    `<div style="font-weight:700;margin-bottom:8px">To-Do Liste</div>` +
    `<div><button id="btn-add-todo" class="btn">+ To-Do hinzufügen</button></div>` +
    `<div id="todo-container" class="todo-list" style="margin-top:8px">`;
  if ((pdata.todos||[]).length === 0){
    html += `<div class="muted">Keine To-Dos</div>`;
  } else {
    pdata.todos.forEach(td=>{
      html += `<div class="todo-row" data-id="${td.id}">` +
              `<input type="checkbox" disabled ${td.done ? 'checked' : ''} />` +
              `<div class="todo-text" style="flex:1">${escapeHtml(td.text)}</div>` +
              `<div class="muted" style="min-width:90px;text-align:right">` +
                `<button class="btn edit-todo" data-id="${td.id}" style="display:none">✎</button>` +
                `<button class="btn del-todo" data-id="${td.id}" style="display:none">🗑</button>` +
              `</div>` +
              `</div>`;
    });
  }
  html += `</div></div>`; // right card

  html += `</div>`; // person-columns
  html += `</div>`; // outer card

  app.innerHTML = html;

  // wire events
  document.querySelectorAll('.date-item').forEach(el=>{
    el.addEventListener('click', ()=> {
      const d = el.dataset.date;
      navigateTo('#/person/' + encodeURIComponent(personName) + '?date=' + encodeURIComponent(d));
    });
  });

  document.getElementById('btn-add-entry').addEventListener('click', ()=>{
    openModal(`Neuer Eintrag für ${fmtDE(selDate)}`, `
      <label>Text</label>
      <textarea id="modal-text" rows="4"></textarea>
    `, async ()=>{
      const text = document.getElementById('modal-text').value.trim();
      if (!text) { alert('Text leer'); return false; }
      const newEntry = {id: uid('e'), text};
      DATA.persons[personName].entries[selDate].push(newEntry);
      saveData(DATA);
      renderPersonPage(personName, {date:selDate});
      return true;
    });
  });

  // edit/save toggling
  const btnEdit = document.getElementById('btn-edit');
  const btnSave = document.getElementById('btn-save');
  let editing = false;
  btnEdit.addEventListener('click', async ()=>{
    // require password if needed
    const pers = PERSONS.find(p=>p.id===personName);
    if (pers && pers.pwd && pers.pwd.length > 0){
      const ok = await askPassword(personName, pers.pwd);
      if (!ok) { alert('Falsches Passwort'); return; }
    }
    enableEditMode();
  });
  btnSave.addEventListener('click', ()=>{
    // save overnight and todos state from DOM
    const note = document.getElementById('overnote').value;
    const booked = document.getElementById('overn-booked').checked;
    DATA.persons[personName].overnight[selDate] = {note, booked};
    // todo items: iterate DOM
    const todoNodes = document.querySelectorAll('#todo-container .todo-row');
    const newTodos = [];
    todoNodes.forEach(n=>{
      const id = n.dataset.id;
      const text = (n.querySelector('.todo-text').innerText || '').trim();
      const done = n.querySelector('input[type=checkbox]').checked;
      newTodos.push({id, text, done});
    });
    DATA.persons[personName].todos = newTodos;
    // entries: iterate DOM entries
    const entryNodes = document.querySelectorAll('#entries-container .entry-row');
    const newEntries = [];
    entryNodes.forEach(n=>{
      const id = n.dataset.id;
      const text = (n.querySelector('.entry-text').innerText || '').trim();
      newEntries.push({id, text});
    });
    DATA.persons[personName].entries[selDate] = newEntries;
    saveData(DATA);
    disableEditMode();
    renderPersonPage(personName, {date:selDate});
  });
  function enableEditMode(){
    editing = true;
    btnEdit.style.display='none';
    btnSave.style.display='inline-block';
    // enable UI: inputs, edit/delete buttons visible
    const cb = document.getElementById('overn-booked');
    cb.disabled = false;
    document.getElementById('overnote').disabled = false;
    document.querySelectorAll('.edit-entry, .del-entry, .edit-todo, .del-todo').forEach(b=>b.style.display='inline-block');
    document.querySelectorAll('#entries-container .entry-text').forEach(n=>{
      n.contentEditable = true; n.style.outline='1px dashed rgba(255,255,255,0.03)'; n.style.padding='6px'; n.style.borderRadius='6px';
    });
    document.querySelectorAll('#todo-container .todo-text').forEach(n=>{
      n.contentEditable = true; n.style.outline='1px dashed rgba(255,255,255,0.03)'; n.style.padding='4px'; n.style.borderRadius='6px';
    });
    // make checkboxes clickable
    document.querySelectorAll('#todo-container input[type=checkbox]').forEach(cb=>cb.disabled=false);
    // wire edit/delete actions
    document.querySelectorAll('.del-entry').forEach(b=>{
      b.addEventListener('click', (e)=>{
        const id = b.dataset.id;
        if (!confirm('Eintrag löschen?')) return;
        const arr = DATA.persons[personName].entries[selDate];
        DATA.persons[personName].entries[selDate] = arr.filter(x=>x.id!==id);
        saveData(DATA);
        renderPersonPage(personName, {date:selDate});
      });
    });
    document.querySelectorAll('.edit-entry').forEach(b=>{
      b.addEventListener('click', ()=>{
        const id = b.dataset.id;
        const eNode = document.querySelector(`#entries-container .entry-row[data-id="${id}"] .entry-text`);
        if (!eNode) return;
        openModal('Bearbeite Eintrag', `<textarea id="modal-text" rows="6">${escapeHtml(eNode.innerText)}</textarea>`, ()=>{
          const t = document.getElementById('modal-text').value.trim();
          if (!t) { alert('Text leer'); return false; }
          const arr = DATA.persons[personName].entries[selDate];
          const it = arr.find(x=>x.id===id);
          if (it) it.text = t;
          saveData(DATA);
          renderPersonPage(personName, {date:selDate});
          return true;
        });
      });
    });
    // todos
    document.querySelectorAll('.del-todo').forEach(b=>{
      b.addEventListener('click', ()=>{
        const id = b.dataset.id;
        if (!confirm('To-Do löschen?')) return;
        DATA.persons[personName].todos = DATA.persons[personName].todos.filter(x=>x.id!==id);
        saveData(DATA);
        renderPersonPage(personName, {date:selDate});
      });
    });
    document.querySelectorAll('.edit-todo').forEach(b=>{
      b.addEventListener('click', ()=>{
        const id = b.dataset.id;
        const nd = document.querySelector(`#todo-container .todo-row[data-id="${id}"] .todo-text`);
        openModal('Bearbeite To-Do', `<textarea id="modal-text" rows="4">${escapeHtml(nd.innerText)}</textarea>`, ()=>{
          const t = document.getElementById('modal-text').value.trim();
          if (!t){ alert('Text leer'); return false; }
          const it = DATA.persons[personName].todos.find(x=>x.id===id);
          if (it) it.text = t;
          saveData(DATA);
          renderPersonPage(personName, {date:selDate});
          return true;
        });
      });
    });
  }
  function disableEditMode(){
    editing = false;
    btnEdit.style.display='inline-block';
    btnSave.style.display='none';
    const cb = document.getElementById('overn-booked');
    if (cb) cb.disabled = true;
    const on = document.getElementById('overnote');
    if (on) on.disabled = true;
    document.querySelectorAll('.edit-entry, .del-entry, .edit-todo, .del-todo').forEach(b=>b.style.display='none');
    document.querySelectorAll('#entries-container .entry-text').forEach(n=>{
      n.contentEditable = false; n.style.outline=''; n.style.padding=''; n.style.borderRadius='';
    });
    document.querySelectorAll('#todo-container .todo-text').forEach(n=>{
      n.contentEditable = false; n.style.outline=''; n.style.padding=''; n.style.borderRadius='';
    });
    document.querySelectorAll('#todo-container input[type=checkbox]').forEach(cb=>cb.disabled=true);
  }

  // add todo
  document.getElementById('btn-add-todo').addEventListener('click', ()=>{
    openModal('Neues To-Do', `<label>Text</label><textarea id="modal-text" rows="3"></textarea>`, ()=>{
      const t = document.getElementById('modal-text').value.trim();
      if (!t) { alert('Text leer'); return false; }
      DATA.persons[personName].todos.push({id: uid('td'), text: t, done:false});
      saveData(DATA);
      renderPersonPage(personName, {date:selDate});
      return true;
    });
  });

  // checkbox in todo (view mode disabled)
  document.querySelectorAll('#todo-container input[type=checkbox]').forEach(cb=>{
    cb.addEventListener('change', ()=>{
      const id = cb.closest('.todo-row').dataset.id;
      const it = DATA.persons[personName].todos.find(x=>x.id===id);
      if (it) { it.done = cb.checked; saveData(DATA); }
    });
  });

  // Overn note/booked edits allowed only in edit mode; Save handles saving

  // translate buttons
  document.getElementById('btn-translate-th').addEventListener('click', async ()=>{
    showTemp('Übersetze... (Thai)');
    await translatePerson(personName, 'th');
    renderPersonPage(personName, {date:selDate});
  });
  document.getElementById('btn-translate-de').addEventListener('click', async ()=>{
    // restore originals if any
    restoreOriginals(personName);
    renderPersonPage(personName, {date:selDate});
  });

  // entry click editing allowed via edit buttons (see enableEditMode)
  // make sure checkboxes disabled in view mode
  disableEditMode();
}

/* ---------- translation ---------- */
async function translatePerson(personName, targetLang){
  // translate all entries, overnight note and todos - store originals in item.originalText
  // We'll attempt to use TRANSLATE_ENDPOINT; if fails, show alert.
  DATA = loadData();
  try {
    // collect texts to translate
    const texts = [];
    const map = [];
    // entries
    const per = DATA.persons[personName];
    for (const date of DATA.dates){
      for (const it of per.entries[date]){
        if (!it.originalText) it.originalText = it.text;
        if (!it._translated || it._translated.target !== targetLang){
          texts.push(it.text);
          map.push({type:'entry', date, id: it.id});
        }
      }
      // overnight note
      const ov = per.overnight[date];
      if (ov && ov.note){
        if (!ov.original) ov.original = ov.note;
        if (!ov._translated || ov._translated.target !== targetLang){
          texts.push(ov.note);
          map.push({type:'overn', date});
        }
      }
    }
    // todos
    for (const td of per.todos){
      if (!td.originalText) td.originalText = td.text;
      if (!td._translated || td._translated.target !== targetLang){
        texts.push(td.text);
        map.push({type:'todo', id: td.id});
      }
    }
    if (texts.length === 0){
      alert('Keine Texte zum Übersetzen oder bereits übersetzt.');
      return;
    }
    // translate sequentially (simple)
    for (let i=0;i<texts.length;i++){
      const txt = texts[i];
      const m = map[i];
      const translated = await translateText(txt, 'de', targetLang);
      if (!translated) {
        alert('Übersetzung fehlgeschlagen (API/Netzwerk).');
        return;
      }
      if (m.type === 'entry'){
        const arr = DATA.persons[personName].entries[m.date];
        const it = arr.find(x=>x.id===m.id);
        if (it){ it.text = translated; it._translated = {target:targetLang}; }
      } else if (m.type === 'overn'){
        DATA.persons[personName].overnight[m.date].note = translated;
        DATA.persons[personName].overnight[m.date]._translated = {target:targetLang};
      } else if (m.type === 'todo'){
        const t = DATA.persons[personName].todos.find(x=>x.id===m.id);
        if (t){ t.text = translated; t._translated = {target:targetLang}; }
      }
      // minor delay to be polite
      await new Promise(r=>setTimeout(r, 200));
    }
    saveData(DATA);
    alert('Übersetzung abgeschlossen.');
  } catch(e){
    console.error(e);
    alert('Übersetzung fehlgeschlagen: ' + (e.message||e));
  }
}

function restoreOriginals(personName){
  DATA = loadData();
  const per = DATA.persons[personName];
  for (const date of DATA.dates){
    for (const it of per.entries[date]){
      if (it.originalText) { it.text = it.originalText; delete it._translated; }
    }
    const ov = per.overnight[date];
    if (ov && ov.original){ ov.note = ov.original; delete ov._translated; }
  }
  for (const td of per.todos){
    if (td.originalText) { td.text = td.originalText; delete td._translated; }
  }
  saveData(DATA);
  alert('Deutsch wiederhergestellt (Originaltexte).');
}

async function translateText(text, source='de', target='th'){
  // basic cache in DATA.translations
  const key = 't|' + source + '|' + target + '|' + text;
  if (DATA.translations && DATA.translations[key]) return DATA.translations[key];

  try {
    const res = await fetch(TRANSLATE_ENDPOINT, {
      method:'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({q:text, source:source, target:target, format:'text'})
    });
    if (!res.ok) { console.error('translate error', res.statusText); return null; }
    const j = await res.json();
    const translated = j.translatedText || j.translated || null;
    if (translated){
      DATA.translations = DATA.translations || {};
      DATA.translations[key] = translated;
      saveData(DATA);
      return translated;
    }
    return null;
  } catch(e){
    console.error('translate fetch error', e);
    return null;
  }
}

/* ---------- modal & password helpers ---------- */
function openModal(title, innerHtml, onOk){
  const modal = document.getElementById('modal');
  const content = document.getElementById('modal-content');
  content.innerHTML = `<h3 style="margin-top:0">${title}</h3>` + innerHtml;
  modal.style.display = 'flex';
  document.getElementById('modal-cancel').onclick = ()=> { modal.style.display='none'; };
  document.getElementById('modal-ok').onclick = async ()=>{
    const ok = await onOk();
    if (ok) modal.style.display='none';
  };
}
function escapeHtml(s){
  if (!s) return '';
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}
async function askPassword(personName, correctPwd){
  // if correctPwd empty, allow
  if (!correctPwd || correctPwd.length===0) return true;
  const p = prompt('Passwort eingeben für ' + personName);
  if (p === null) return false;
  return p === correctPwd;
}
function showTemp(msg){
  alert(msg);
}

/* ---------- routing on hashchange ---------- */
window.addEventListener('hashchange', ()=> route());
function route(){
  const parsed = parseHash();
  if (parsed.view === 'person'){
    renderPersonPage(parsed.person, parsed.params);
  } else {
    renderMain();
  }
}
route(); // initial
</script>
</body>
</html>